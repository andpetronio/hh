---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import type { Translations } from "../../i18n/schema";
import { resolveRequestLocale } from "../../i18n/resolveRequestLocale";
import { getTranslations } from "../../i18n";
interface Props {
  t: Translations;
}

// üåç idioma
const locale = resolveRequestLocale(Astro.request);
const t = getTranslations(locale);
---

<Layout
  title={t.header.becomeTasker}
  description={t.specialists.strings.subtitle}
  locale={locale}
>
  <Header locale={locale} t={t} />

  <main class="max-w-3xl mx-auto px-4 py-10">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">
      {t.header.becomeTasker}
    </h1>

    <p class="text-gray-600 mb-8">
      {t.specialists.strings.subtitle}
    </p>

    <section
      id="preview-card"
      class="bg-white border border-gray-200 rounded-xl p-6 space-y-6 hidden"
    >
      <div>
        <h2 class="text-lg font-semibold text-gray-900 mb-2">
          {t.header.becomeTasker}
        </h2>

        <div class="space-y-1">
          <p class="text-xl font-bold text-gray-900" id="pv-name"></p>
          <p class="text-sm text-gray-600" id="pv-trade"></p>
        </div>
      </div>

      <hr class="border-gray-200" />

      <div>
        <h3 class="text-sm font-semibold text-gray-700 mb-1">
          {t.profile.location}
        </h3>
        <p class="text-sm text-gray-800" id="pv-location"></p>
      </div>

      <div>
        <h3 class="text-sm font-semibold text-gray-700 mb-1">
          {t.specialists.strings.services}
        </h3>
        <p
          class="text-sm text-gray-800 leading-relaxed whitespace-pre-line"
          id="pv-services"
        >
        </p>
      </div>

      <div>
        <h3 class="text-sm font-semibold text-gray-700 mb-1">
          {t.specialists.strings.yearsOfExperience}
        </h3>
        <p class="text-sm text-gray-800" id="pv-experience"></p>
      </div>

      <div
        class="flex items-center justify-between bg-gray-50 rounded-lg px-4 py-3"
      >
        <span class="text-sm text-gray-600">
          {t.specialists.strings.hourlyRate}
        </span>
        <span class="text-lg font-semibold text-gray-900" id="pv-rate"></span>
      </div>
    </section>

    <div class="mt-8 flex gap-4">
      <button
        id="back-btn"
        class="px-6 py-3 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50"
      >
        {t.profile.backToResults}
      </button>

      <button
        id="confirm-btn"
        class="px-6 py-3 rounded-lg bg-[#E07A5F] text-white hover:bg-[#d46c51]"
      >
        {t.header.signUp}
      </button>
    </div>
  </main>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const STORAGE_KEY = "specialists-draft";

    const raw = sessionStorage.getItem(STORAGE_KEY);

    if (!raw) {
      window.location.href = "/specialists/create";
      return;
    }

    let data;
    try {
      data = JSON.parse(raw);
      console.log(data);
    } catch {
      sessionStorage.removeItem(STORAGE_KEY);
      window.location.href = "/specialists/create";
      return;
    }

    // Cachear elementos
    const card = document.getElementById("preview-card");
    const nameEl = document.getElementById("pv-name");
    const tradeEl = document.getElementById("pv-trade");
    const locationEl = document.getElementById("pv-location");
    const servicesEl = document.getElementById("pv-services");
    const experienceEl = document.getElementById("pv-experience");
    const rateEl = document.getElementById("pv-rate");

    if (
      !card ||
      !nameEl ||
      !tradeEl ||
      !locationEl ||
      !servicesEl ||
      !experienceEl ||
      !rateEl
    ) {
      console.error("Preview elements missing");
      return;
    }

    card.classList.remove("hidden");

    nameEl.textContent =
      `${data.firstName ?? ""} ${data.lastName ?? ""}`.trim();

    tradeEl.textContent = data.specialty || "";

    locationEl.textContent =
      data.city && data.region
        ? `üìç ${data.region}, ${data.city} - ${data.country}`
        : "";

    servicesEl.textContent = data.services || "";

    experienceEl.textContent =
      data.yearsOfExperience != null
        ? `${data.yearsOfExperience} a√±os de experiencia`
        : "";

    rateEl.textContent =
      data.hourlyRate != null ? `$${data.hourlyRate} / hora` : "";

    document.getElementById("back-btn")?.addEventListener("click", () => {
      window.location.href = "/specialists/create";
    });

    document.getElementById("confirm-btn")?.addEventListener("click", () => {
      console.log("Confirmar perfil:", data);
      sessionStorage.removeItem(STORAGE_KEY);
      alert("Perfil creado (mock)");
    });
  });
</script>
