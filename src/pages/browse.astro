---
import { getTranslations } from "../i18n";
import { resolveRequestLocale } from "../i18n/resolveRequestLocale";

import Layout from "../layouts/Layout.astro";
import ManerCard from "../components/ManerCard.astro";
import AdBanner from "../components/AdBanner.astro";

import { trades } from "../data/trades";
import {
  getManers,
  getManersByTrade,
  searchManers,
  countManersByTrade,
} from "../lib/queries/getManers";

const locale = resolveRequestLocale(Astro.request);
const t = getTranslations(locale);

const url = new URL(Astro.request.url);
const tradeParam = url.searchParams.get("trade");
const searchQuery = url.searchParams.get("q");

// Obtener maners seg√∫n filtros
let maners = [];
let title = t.browse.allManers;

if (searchQuery && searchQuery.trim().length > 0) {
  // ‚úÖ B√∫squeda por texto
  maners = await searchManers(searchQuery, locale);
  title = `${t.browse.searchResults}: "${searchQuery}"`;
} else if (tradeParam) {
  // ‚úÖ Filtro por trade
  maners = await getManersByTrade(tradeParam, locale);
  const tr = trades.find((x) => x.id === tradeParam);
  title = tr ? t.trades[tr.id] : t.browse.allManers;
} else {
  // ‚úÖ Todos los maners
  maners = await getManers(locale);
}

// Obtener conteos por trade para mostrar en filtros (opcional)
const tradeCounts = await countManersByTrade();
---

<Layout
  title={`${title} - Manify`}
  description="Encuentra manos h√°biles verificadas en tu √°rea"
>
  <main class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-8">
      <!-- Header -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 font-serif">
            {title}
          </h1>

          {
            (tradeParam || searchQuery) && (
              <a
                href="/browse"
                class="text-[#E07A5F] font-medium text-sm hover:underline"
              >
                {t.browse.clearFilter}
              </a>
            )
          }
        </div>

        <!-- Search Bar -->
        <div class="mb-4">
          <form action="/browse" method="get" class="flex gap-2">
            <input
              type="text"
              name="q"
              value={searchQuery || ""}
              placeholder={t.browse.browseManers}
              class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E07A5F]"
            />
            <button
              type="submit"
              class="bg-[#E07A5F] text-white px-6 py-2 rounded-lg font-medium hover:bg-[#d46c51] transition-colors"
            >
              {t.browse.browseBtnText}
            </button>
          </form>
        </div>

        <!-- Trade Filters -->
        <div class="overflow-x-auto pb-2 -mx-4 px-4 sm:mx-0 sm:px-0">
          <div class="flex gap-2 flex-wrap">
            <a
              href="/browse"
              class:list={[
                "px-4 py-2 rounded-full font-medium text-sm transition-all whitespace-nowrap",
                !tradeParam
                  ? "bg-[#E07A5F] text-white"
                  : "bg-white text-gray-700 border border-gray-200 hover:border-[#E07A5F]",
              ]}
            >
              üåç {t.browse.viewAll}
              {
                tradeCounts &&
                  Object.values(tradeCounts).reduce((a, b) => a + b, 0) > 0 && (
                    <span class="ml-1 text-xs opacity-75">
                      ({Object.values(tradeCounts).reduce((a, b) => a + b, 0)})
                    </span>
                  )
              }
            </a>

            {
              trades.map((cat) => (
                <a
                  href={`/browse?trade=${cat.id}`}
                  class:list={[
                    "px-4 py-2 rounded-full font-medium text-sm transition-all whitespace-nowrap",
                    tradeParam === cat.id
                      ? "bg-[#E07A5F] text-white"
                      : "bg-white text-gray-700 border border-gray-200 hover:border-[#E07A5F]",
                  ]}
                >
                  {cat.icon} {t.trades[cat.id]}
                  {tradeCounts[cat.id] && (
                    <span class="ml-1 text-xs opacity-75">
                      ({tradeCounts[cat.id]})
                    </span>
                  )}
                </a>
              ))
            }
          </div>
        </div>
      </div>

      <AdBanner t={t} />

      <!-- Results Count -->
      <div class="mb-4 text-gray-600">
        {maners.length}
        {locale === "es" ? "resultados" : "resultados"}
      </div>

      <!-- Maners Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {
          maners.map((m) => {
            // Construir experienceLabel
            const experienceLabel =
              m.experienceYears != null &&
              `${m.experienceYears} ${t.time.years} de ${t.browse.experience}`;

            return (
              <ManerCard
                id={m.id}
                name={m.name || "Sin nombre"}
                tradeLabel={m.tradeLabel || ""}
                locationLabel={m.location || ""}
                rating={m.rating}
                reviewsCount={m.reviewsCount}
                rate={m.rate}
                rateType={m.rateType || "negotiable"}
                minimumHours={m.minimumHours}
                experienceLabel={experienceLabel}
                verified={m.verified}
                image={m.avatar ?? "üë§"}
                bio={m.bio ?? ""}
                skills={m.skills}
                locale={locale}
              />
            );
          })
        }
      </div>

      <!-- No Results -->
      {
        maners.length === 0 && (
          <div class="text-center py-16">
            <div class="text-6xl mb-4">üîç</div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">
              {t.browse.noResults}
            </h3>
            <p class="text-gray-600 mb-6">{t.browse.noResultsDesc}</p>
            <a
              href="/browse"
              class="inline-block bg-[#E07A5F] text-white px-6 py-3 rounded-lg font-medium hover:bg-[#d46c51] transition-colors"
            >
              {t.browse.viewAll}
            </a>
          </div>
        )
      }
    </div>
  </main>
</Layout>
