---
import type { TradeId } from "../data/trades";
import type { Locale } from "../i18n/locales";

// import { getClientLocale } from "../i18n/localeStore";
import { getTranslations } from "../i18n";
import { resolveRequestLocale } from "../i18n/resolveRequestLocale";

import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import ManerCard from "../components/ManerCard.astro";
import AdBanner from "../components/AdBanner.astro";

import { trades } from "../data/trades";
import { maners, getManersByTrade, searchManers } from "../data/maners";
// üåç idioma
const locale = resolveRequestLocale(Astro.request);
const t = getTranslations(locale);

// üîé query params
const url = new URL(Astro.request.url);
const tradeParam = url.searchParams.get("trade");
const searchQuery = url.searchParams.get("q");

// üë∑‚Äç‚ôÇÔ∏è resultados
let filteredManers = maners;
let title = t.browse.allManers;

// üîß filtro por oficio
if (typeof tradeParam === "string") {
  const trade = tradeParam as TradeId;
  filteredManers = getManersByTrade(trade);

  const tr = trades.find((t) => t.id === trade);
  title = tr ? t.trades[tr.id] : t.browse.allManers;
}

// üîç b√∫squeda
else if (typeof searchQuery === "string") {
  filteredManers = searchManers(searchQuery);
  title = t.browse.searchResults;
}
---

<Layout
  title={`${title} - Manify`}
  description="Encuentra manos h√°biles verificados en tu √°rea"
  locale={locale}
>
  <Header t={t} locale={locale} />

  <main class="min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-8">
      <!-- Header -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 font-serif">
            {title}
          </h1>

          {
            tradeParam && (
              <a
                href="/browse"
                class="text-[#E07A5F] font-medium text-sm hover:underline"
              >
                {t.browse.clearFilter}
              </a>
            )
          }
        </div>

        <!-- Filtros -->
        <div class="overflow-x-auto pb-2 -mx-4 px-4 sm:mx-0 sm:px-0">
          <div class="flex gap-2 flex-wrap">
            <!-- Ver todos -->
            <a
              href="/browse"
              class:list={[
                "px-4 py-2 rounded-full font-medium text-sm transition-all",
                !tradeParam
                  ? "bg-[#E07A5F] text-white"
                  : "bg-white text-gray-700 border border-gray-200 hover:border-[#E07A5F]",
              ]}
            >
              üåç {t.browse.viewAll}
            </a>

            <!-- Trades -->
            {
              trades.map((cat) => (
                <a
                  href={`/browse?trade=${cat.id}`}
                  class:list={[
                    "px-4 py-2 rounded-full font-medium text-sm transition-all",
                    tradeParam === cat.id
                      ? "bg-[#E07A5F] text-white"
                      : "bg-white text-gray-700 border border-gray-200 hover:border-[#E07A5F]",
                  ]}
                >
                  {cat.icon} {t.trades[cat.id]}
                </a>
              ))
            }
          </div>
        </div>
      </div>

      <AdBanner t={t} />

      <!-- Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {
          filteredManers.map((maner) => (
            <ManerCard
              id={maner.id}
              name={t.maners[maner.nameKey].name}
              trade={maner.trade}
              rating={maner.rating}
              reviews={maner.reviews}
              hourlyRate={maner.hourlyRate}
              location={maner.location}
              experience={maner.experience}
              verified={maner.verified}
              image={maner.image}
              bio={t.maners[maner.nameKey].bio}
              skills={t.maners[maner.nameKey].skills}
              locale={locale}
              t={t}
            />
          ))
        }
      </div>

      <!-- Empty state -->
      {
        filteredManers.length === 0 && (
          <div class="text-center py-16">
            <div class="text-6xl mb-4">üîç</div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">
              {t.browse.noResults}
            </h3>
            <p class="text-gray-600 mb-6">{t.browse.noResultsDesc}</p>
            <a
              href="/browse"
              class="inline-block bg-[#E07A5F] text-white px-6 py-3 rounded-lg font-medium hover:bg-[#d46c51] transition-colors"
            >
              {t.browse.viewAll}
            </a>
          </div>
        )
      }
    </div>
  </main>
</Layout>
